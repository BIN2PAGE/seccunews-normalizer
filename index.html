<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Good Morning, 9 o'clock Security News</title>
  <link rel="stylesheet" href="assets/sunrise.css">
</head>
<body class="sunrise">
  <header>
    <div class="title">â˜€ êµ¿ëª¨ë‹, 9ì‹œ ë³´ì•ˆ ë‰´ìŠ¤</div>
    <div id="status" class="subtitle">ì „ë‚  09:00â€“ì˜¤ëŠ˜ 09:00 ê¸°ì‚¬, ì¤‘ìš”ë„ìˆœ ìë™ ì •ë ¬</div>

    <div class="bar">
      <div id="tabs" class="bar" style="gap:8px;">
        <button class="tab active" data-cat="ALL">ì „ì²´</button>
        <button class="tab" data-cat="OCEAN">í•´ì–‘</button>
        <button class="tab" data-cat="FORENSICS">í¬ë Œì‹</button>
        <button class="tab" data-cat="AI">AI</button>
      </div>
	  
	  <div id="srcTabs" class="bar" style="gap:8px;">
	    <button class="tab active" data-src="ALL">ì „ì²´ ì†ŒìŠ¤</button>
	    <button class="tab" data-src="ë³´ì•ˆë‰´ìŠ¤">ë³´ì•ˆë‰´ìŠ¤</button>
	    <button class="tab" data-src="ë°ì¼ë¦¬ì‹œí">ë°ì¼ë¦¬ì‹œí</button>
	  </div>

      <div class="datebox" style="margin-left:auto">
	    <a class="tab" id="allBtn" href="all.html">ì „ì²´ ê¸°ì‚¬</a>
        <button class="tab" id="prevDay">â—€ï¸ ì „ë‚ </button>
        <input type="date" id="dayPicker" />
        <button class="tab" id="nextDay">ë‹¤ìŒë‚  â–¶ï¸</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div id="list" class="grid">
      <div class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </div>
  </div>

  <script>
/* ===== ì¹´í…Œê³ ë¦¬ í‚¤ì›Œë“œ ===== */
const CATS = {
  OCEAN: ["í•´ì–‘","í•´ì–‘ì•ˆì „","í•´ìƒ","í•´ì—­","ì—°ì•ˆ","í•­ë§Œ","í•­ë¡œ","í•­í–‰","ì„ ë°•","í•´ìš´","í•´ì–‘ìˆ˜ì‚°ë¶€","í•´ìˆ˜ë¶€","í•´ì–‘ê²½ì°°","í•´ì–‘ê²½ì°°ì²­","maritime","coast guard","imo"],
  FORENSICS: ["í¬ë Œì‹","ë””ì§€í„¸í¬ë Œì‹","ë””ì§€í„¸ í¬ë Œì‹","dfir","ë©”ëª¨ë¦¬ í¬ë Œì‹","ëª¨ë°”ì¼ í¬ë Œì‹","ì´ë¯¸ì§€ ì¶”ì¶œ","ì¦ê±° ë³´ì¡´","ë¡œê·¸ ë¶„ì„","íƒ€ì„ë¼ì¸ ë¶„ì„","ë²•ê³¼í•™","forensic"],
  AI: ["AI","ì¸ê³µì§€ëŠ¥","ìƒì„±í˜•","ì—ì´ì „íŠ¸","í”„ë¡¬í”„íŠ¸","RAG","ì½”íŒŒì¼ëŸ¿", "í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜","ë°ì´í„° ì¤‘ë…","ëª¨ë¸ í¬ì´ì¦ˆë‹","LLM","MCP","Agent","RAG","Copilot","model","ai","llm","agent","mcp","rag","copilot"]
};

/* --- í•´ì–‘ ì¹´í…Œê³ ë¦¬ ì—„ê²© í¬í•¨ì–´ & ì œì™¸ì–´ (ì˜¤ê²€ì¶œ ë°©ì§€) --- */
// í¬í•¨ì–´: ì§„ì§œ í•´ì–‘/í•´ìš´ ë§¥ë½ì—ì„œë§Œ ë‚˜ì˜¤ëŠ” ê²ƒ ìœ„ì£¼ (ëª¨í˜¸í•œ 'ì„ ì‚¬'ëŠ” ì œì™¸)
const OCEAN_INCLUDE_STRICT = [
  "í•´ì–‘","í•´ìƒ","ì—°ì•ˆ","í•­ë§Œ","í•­ë¡œ","í•­í–‰","ì„ ë°•","í•´ìš´",
  "í•´ì–‘ìˆ˜ì‚°ë¶€","í•´ìˆ˜ë¶€","í•´ì–‘ê²½ì°°","í•´ì–‘ê²½ì°°ì²­","maritime","coast guard","imo"
];

// ì œì™¸ì–´: í™ë³´/ìœ í†µ/ìƒí™œ ì¹´í…Œê³ ë¦¬ ë‹¨ì–´ â†’ í•´ì–‘ íƒ­ì—ì„œ ì œì™¸
const OCEAN_EXCLUDES = [
  "ì¶œì‹œ","í• ì¸","ì„¸ì¼","ì´ë²¤íŠ¸","í”„ë¡œëª¨ì…˜","íŒì—…","ì˜¤í”ˆ","ë¦¬ë‰´ì–¼","ì˜ˆì•½ íŒë§¤","ì˜ˆì•½íŒë§¤",
  "í”Œë˜ê·¸ì‹­","ê°€ì „","ë·°í‹°","íŒ¨ì…˜","ì‡¼í•‘","ë§¤ì¥","ì˜¤í”„ë¼ì¸","íŠ¹ê°€","ì¦ì •","ì²´í—˜ë‹¨","í˜‘ì°¬",
  "ìº í•‘","í…íŠ¸","í”Œë¦¬ìŠ¤","ìŠ¤ë‹ˆì»¤ì¦ˆ","ê°€êµ¬","ì¸í…Œë¦¬ì–´","í”„ë¡œì í„°","í–¥ìˆ˜","ë°±í™”ì ","ì…ì "
];

/* ===== ìƒíƒœ/DOM ===== */
const listEl   = document.getElementById("list");
const tabsEl   = document.getElementById("tabs");
const statusEl = document.getElementById("status");
const picker   = document.getElementById("dayPicker");
const prevBtn  = document.getElementById("prevDay");
const nextBtn  = document.getElementById("nextDay");
const allBtn  = document.getElementById("allBtn");
const srcTabs = document.getElementById("srcTabs");


let entriesMain  = [];   // [ì–´ì œ 09:00, ì˜¤ëŠ˜ 09:00)
let entriesExtra = [];   // [ì˜¤ëŠ˜ 09:00, ì§€ê¸ˆ)
let activeCat = "ALL";
let activeSrc = "ALL";
const LIMIT = 20;

function matchSource(item){
  return activeSrc === "ALL" || (item.source || "") === activeSrc;
}

/* ===== ìœ í‹¸ ===== */
function stripTags(html){ const d=document.createElement("div"); d.innerHTML=html||""; return (d.textContent||d.innerText||"").trim(); }
function formatDate(s){
  if (!s) return "";
  const d = new Date(s);
  if (isNaN(d)) return s;
  const p = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
}
function hasHangul(s){ return /[ê°€-í£]/.test(s); }
function makeBoundaryRegex(keyword){ const esc=keyword.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"); return new RegExp(`(^|[^0-9A-Za-zê°€-í£])(${esc})`,"i"); }
function keywordMatch(text, keywords){
  const normalized=(text||"").replace(/\s+/g," ");
  const lower=normalized.toLowerCase();
  for(const kw of (keywords||[])){
    if (hasHangul(kw)) { if (lower.includes(kw.toLowerCase())) return true; }
    else { if (makeBoundaryRegex(kw).test(normalized)) return true; }
  }
  return false;
}
function matchCategory(item, cat){
  if (cat === "ALL") return true;

  const text = (item.title + " " + (item.summary || item.description || "")).trim();

  // í•´ì–‘: ì—„ê²© í¬í•¨ì–´ + ì œì™¸ì–´ í•„í„° (ì„œë²„ cats ë¬´ì‹œ)
  if (cat === "OCEAN") {
    const inc = keywordMatch(text, OCEAN_INCLUDE_STRICT);
    const exc = keywordMatch(text, OCEAN_EXCLUDES);
    return inc && !exc;
  }

  // ë‚˜ë¨¸ì§€: ì„œë²„ cats OR í‚¤ì›Œë“œ ë§¤ì¹­
  if (Array.isArray(item.cats) && item.cats.includes(cat)) return true;
  return keywordMatch(text, CATS[cat]);
}

function ymd(d){ const p=n=>String(n).padStart(2,"0"); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
function setPicker(d){ picker.value = ymd(d); }
function parsePicker(){ const v=picker.value; if(!v) return null; const [Y,M,D]=v.split("-").map(Number); return new Date(Y, M-1, D); }
function getDomain(u){ try { return new URL(u).hostname.replace(/^www\./,''); } catch { return ''; } }
function boundaryUtcISO(dateStr){ return `${dateStr}T00:00:00Z`; } // KST 09:00 ê²½ê³„

// ì„ íƒëœ ë‚ ì§œë¡œ all.html ë§í¬ ë™ê¸°í™”
function updateAllLink(dateStr){
  if (!allBtn) return;
  const q = dateStr ? `?date=${encodeURIComponent(dateStr)}` : "";
  allBtn.href = `all.html${q}`;
}


/* ê°„ë‹¨ ë³´ì•ˆ ê´€ë ¨ì„± í•„í„° (feed fallback ì•ˆì „ë§) */
function isSecurityRelevant(title, summary){
  const inc = ["ë³´ì•ˆ","í•´í‚¹","ì‚¬ì´ë²„","ì¹¨í•´","ìœ ì¶œ","ê°œì¸ì •ë³´","ëœì„¬ì›¨ì–´","ì•…ì„±ì½”ë“œ",
               "í”¼ì‹±","ìŠ¤ë¯¸ì‹±","ì·¨ì•½ì ","ì œë¡œë°ì´","cve","apt","ddos","í¬ë Œì‹","ë””ì§€í„¸í¬ë Œì‹","dfir"];
  const exc = ["ì¶œì‹œ","í• ì¸","ì„¸ì¼","ì´ë²¤íŠ¸","í”„ë¡œëª¨ì…˜","íŒì—…","ì˜¤í”ˆ","ë¦¬ë‰´ì–¼","ì˜ˆì•½ íŒë§¤","ì˜ˆì•½íŒë§¤",
               "í”Œë˜ê·¸ì‹­","ê°€ì „","ë·°í‹°","íŒ¨ì…˜","ì‡¼í•‘","ë§¤ì¥","ì˜¤í”„ë¼ì¸","íŠ¹ê°€","ì¦ì •","ì²´í—˜ë‹¨","í˜‘ì°¬","ìº í•‘","í…íŠ¸"];
  const txt = `${title||""} ${summary||""}`.toLowerCase();
  const hasInc = inc.some(k=>txt.includes(k));
  const hasExc = exc.some(k=>txt.includes(k));
  return hasInc && !hasExc;
}

/* ===== ë Œë” ===== */
function cardHTML(item){
  const title = item.title || "";
  const link  = item.link || "#";
  const desc  = stripTags(item.summary || item.description || "");
  const date  = formatDate(item.published || item.published_kst || item["dc:date"] || "");
  const author= (item.author || item.creator || item["dc:creator"] || "").replace(/^\[|\]$/g,"");
  const cats  = Array.isArray(item.cats) ? item.cats : [];
  const score = typeof item.score === "number" ? item.score.toFixed(1) : "";
  const domain= getDomain(link);
  const chips = [
    ...cats.map(c=>`<span class="chip cat-${c}">${c==="OCEAN"?"í•´ì–‘":c==="FORENSICS"?"í¬ë Œì‹":c==="AI"?"AI":c}</span>`),
    item.source ? `<span class="chip src">${item.source}</span>` : ""
  ].filter(Boolean).join("");
  return `
    <article class="card">
      <h3><a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a></h3>
      <div class="desc">${desc}</div>
      <div class="chips">${chips}</div>
      <div class="meta">
        <span>${date}</span>
        ${author ? `<span>${author}</span>` : ``}
        ${domain ? `<span>${domain}</span>` : ``}
        ${score ? `<span class="score">â˜… ${score}</span>` : ``}
      </div>
    </article>`;
}

function countByCategory(items){
  return {
    ALL: items.length,
    OCEAN: items.filter(e=>matchCategory(e,"OCEAN")).length,
    FORENSICS: items.filter(e=>matchCategory(e,"FORENSICS")).length,
    AI: items.filter(e=>matchCategory(e,"AI")).length,
  };
}
function updateTabCounts(items){
  const c = countByCategory(items);
  document.querySelectorAll("#tabs .tab").forEach(btn=>{
    const base=btn.textContent.split(" (")[0];
    const cat=btn.dataset.cat;
    const n=c[cat] ?? 0;
    btn.textContent = `${base} (${n})`;
    btn.classList.toggle("active", btn.dataset.cat===activeCat);
    btn.style.opacity = (cat!=="ALL" && n===0) ? 0.5 : 1;
  });
}

function renderAll(){
  // 1) í˜„ì¬ ì†ŒìŠ¤ ì„ íƒì„ ë¨¼ì € ë°˜ì˜í•œ í’€ êµ¬ì„±
  const pool = entriesMain.concat(entriesExtra).filter(matchSource);

  // 2) ë©”ì¸/ì´í›„ ì†Œì‹ì— ì†ŒìŠ¤ + ì¹´í…Œê³ ë¦¬ í•„í„° ë™ì‹œ ì ìš©
  const main  = entriesMain
    .filter(matchSource)
    .filter(e => matchCategory(e, activeCat));

  const extra = entriesExtra
    .filter(matchSource)
    .filter(e => matchCategory(e, activeCat));

  const all = main.concat(extra);

  // 3) ë¹„ì—ˆì„ ë•Œ ì²˜ë¦¬ + íƒ­ ì¹´ìš´íŠ¸ëŠ” 'ì†ŒìŠ¤ í•„í„° ì ìš©ëœ í’€' ê¸°ì¤€
  if (!all.length){
    listEl.innerHTML = `<div class="empty">í‘œì‹œí•  ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    updateTabCounts(pool);
    return;
  }

  // 4) ë Œë” (í—¤ë”ë¥¼ ê·¸ë¦¬ë“œ ì „ì²´í­ ì•„ì´í…œìœ¼ë¡œ ë³„ë„ ì‚½ì…)
  const mainHTML   = main.slice(0, LIMIT).map(cardHTML).join("");
  const extraHead  = extra.length ? `
    <div class="full extra-head">
      <span class="extra-badge">ì´í›„ ì†Œì‹</span>
      <span class="extra-sub">ìµœì‹ ìˆœ</span>
    </div>
  ` : "";
  const extraHTML  = extra.length ? extra.map(cardHTML).join("") : "";

  listEl.innerHTML = mainHTML + extraHead + extraHTML;

  // 5) ìƒíƒœë°”(ì´ ê°œìˆ˜ = í˜„ì¬ ì†ŒìŠ¤+ì¹´í…Œê³ ë¦¬ í•„í„° ê²°ê³¼)
  const suffix   = extra.length ? ` + ì´í›„ ${extra.length}ê±´` : "";
  const srcLabel = activeSrc === "ALL" ? "ì „ì²´ ì†ŒìŠ¤" : activeSrc;
  statusEl.innerHTML = statusEl.innerHTML.replace(/Â·.*$/, "") +
    ` Â· <span style="opacity:.8">${all.length}ê±´${suffix} Â· ${srcLabel}</span>`;

  // 6) íƒ­ ì¹´ìš´íŠ¸ ê°±ì‹  (í˜„ì¬ ì†ŒìŠ¤ë§Œ ê³ ë ¤)
  updateTabCounts(pool);
}


/* ===== ì´ë²¤íŠ¸ ===== */
tabsEl.addEventListener("click", (e)=>{
  const btn=e.target.closest(".tab"); if(!btn) return;
  activeCat = btn.dataset.cat || "ALL";
  renderAll();
});
prevBtn.addEventListener("click", ()=>{
  const d=parsePicker() || new Date();
  d.setDate(d.getDate()-1);
  setPicker(d);
  loadByDate(ymd(d));
  refreshNextDisabled();
});
nextBtn.addEventListener("click", ()=>{
  const d = parsePicker() || new Date();
  const today = new Date();
  if (ymd(d) >= ymd(today)) return;
  d.setDate(d.getDate()+1);
  setPicker(d);
  loadByDate(ymd(d));
  refreshNextDisabled();
});
function refreshNextDisabled(){
  const todayStr = ymd(new Date());
  const cur = picker.value || todayStr;
  const lock = (cur >= todayStr);
  nextBtn.disabled = lock;
  nextBtn.style.opacity = lock ? .5 : 1;
}
picker.addEventListener('change', ()=>{
  const d = parsePicker() || new Date();
  const today = new Date();
  if (ymd(d) > ymd(today)) setPicker(today);
  loadByDate(ymd(parsePicker() || today));
  refreshNextDisabled();
});
window.addEventListener('load', refreshNextDisabled);

// ì†ŒìŠ¤ íƒ­ (ALL / ë³´ì•ˆë‰´ìŠ¤ / ë°ì¼ë¦¬ì‹œí)
srcTabs.addEventListener("click", (e)=>{
  const btn = e.target.closest(".tab"); 
  if (!btn) return;
  activeSrc = btn.dataset.src || "ALL";
  // í™œì„± ë²„íŠ¼ ìŠ¤íƒ€ì¼ í† ê¸€
  srcTabs.querySelectorAll(".tab").forEach(b=>{
    b.classList.toggle("active", b === btn);
  });
  renderAll();
});



/* ===== ì•ˆì „ fetch ===== */
async function safeFetchJSON(url){
  try{ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) return null; return await r.json(); }
  catch{ return null; }
}

/* ===== ì˜¤ëŠ˜ ì´í›„ ì†Œì‹ ë¡œë” ===== */
async function loadExtrasIfToday(dateStr){
  entriesExtra = [];
  const todayStr = ymd(new Date());
  if (dateStr !== todayStr) return;

  const feedURL  = new URL('feed.json', location.href).toString();
  const dFeed = await safeFetchJSON(feedURL);
  if (!dFeed?.items?.length) return;

  const startUtc = new Date(boundaryUtcISO(dateStr)).getTime(); // ì˜¤ëŠ˜ 09:00 KST
  const nowUtc   = Date.now();
  const mainLinks = new Set(entriesMain.map(e => e.link));

  const ALLOWED_SOURCES = new Set(["ë³´ì•ˆë‰´ìŠ¤","ë°ì¼ë¦¬ì‹œí"]);

  entriesExtra = dFeed.items
    .filter(it=>{
      const pub = it.published || it.published_raw || "";
      const t = new Date(pub).getTime();
      if (!t || isNaN(t)) return false;
      if (t < startUtc || t >= nowUtc) return false;
      if (mainLinks.has(it.link)) return false;
      // ì†ŒìŠ¤ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë§Œ í—ˆìš©
      if (it.source && !ALLOWED_SOURCES.has(it.source)) return false;
      return true;
    })
    .sort((a,b)=> new Date(b.published||b.published_raw||0) - new Date(a.published||a.published_raw||0))
    .map(e=>({
      title:e.title, link:e.link, summary:e.summary,
      published: e.published || e.published_raw || "",
      author:e.author, cats:e.cats||[], source:e.source||""
    }));
}

/* ===== ë‚ ì§œë³„ ë¡œë” (ì•„ì¹´ì´ë¸Œ â†’ ì˜¤ëŠ˜/daily) + (ì˜¤ëŠ˜ì´ë©´ feedë¡œ ì´í›„ ì†Œì‹) ===== */
async function loadByDate(dateStr){
  const todayStr = ymd(new Date());
  entriesMain = []; entriesExtra = [];

  const archURL  = new URL(`archive/daily-${dateStr}.json`, location.href).toString();
  const dailyURL = new URL('daily.json',  location.href).toString();
  const feedURL  = new URL('feed.json',   location.href).toString();

  if (dateStr > todayStr) {
    statusEl.innerHTML = `â³ <b>ë¯¸ë˜ ë‚ ì§œ</b> Â· ì•„ì§ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤`;
    listEl.innerHTML = `<div class="empty">ë¯¸ë˜ ë‚ ì§œì…ë‹ˆë‹¤. ë‚ ì§œë¥¼ ì´ì „ìœ¼ë¡œ ì„ íƒí•˜ì„¸ìš”.</div>`;
    updateTabCounts([]);
    return;
  }

  // 1) ì•„ì¹´ì´ë¸Œ ìš°ì„ 
  const dArch = await safeFetchJSON(archURL);
  if (dArch?.items?.length){
    entriesMain = dArch.items.map(e=>({
      title:e.title, link:e.link, summary:e.summary,
      published: e.published_kst || e.published || "",
      author:e.author, cats:(e.cats||[]), score:e.score, source:e.source||""
    }));
    statusEl.innerHTML = `ğŸ“… <b>${dateStr}</b> (09:00â†’09:00)`;
  } else if (dateStr === todayStr) {
    // 2) ì˜¤ëŠ˜ì´ë©´ daily.json ì‹œë„
    const dDaily = await safeFetchJSON(dailyURL);
    if (dDaily?.items?.length){
      entriesMain = dDaily.items.map(e=>({
        title:e.title, link:e.link, summary:e.summary,
        published: e.published_kst || e.published || "",
        author:e.author, cats:(e.cats||[]), score:e.score, source:e.source||""
      }));
      statusEl.innerHTML = `ğŸ“… <b>ì˜¤ëŠ˜</b> (09â†’09)`;
    }
  }

  // 3) ë©”ì¸ì´ ë¹„ì—ˆê³  ì˜¤ëŠ˜ì´ë¼ë©´ feedë¡œ "ëŒ€ì²´ ë¡œë“œ"
  if (!entriesMain.length && dateStr === todayStr){
    const dFeed = await safeFetchJSON(feedURL);
    if (dFeed?.items?.length){
      const filtered = dFeed.items.filter(it => isSecurityRelevant(it.title, it.summary));
      entriesMain = filtered.map(e=>({
        title:e.title, link:e.link, summary:e.summary,
        published: e.published || e.published_raw || "",
        author:e.author, cats:e.cats||[], source:e.source||""
      })).sort((a,b)=> new Date(b.published||0) - new Date(a.published||0));
      statusEl.innerHTML = `ğŸ“° <b>ìµœê·¼ ê¸°ì‚¬(ëŒ€ì²´)</b>`;
    }
  }

  // 4) ì˜¤ëŠ˜ì´ë¼ë©´ ì´í›„ ì†Œì‹ ë¶™ì´ê¸°
  await loadExtrasIfToday(dateStr);
  
  // ì „ì²´ ì†Œì‹ë³´ê¸° ë§í¬ ìµœì‹ í™”  â† ì¶”ê°€
  updateAllLink(dateStr);

  // ë Œë”
  renderAll();
}

/* ===== ì´ˆê¸° ì§„ì… ===== */
window.addEventListener('load', ()=>{
  const today=new Date();
  setPicker(today);
  loadByDate(ymd(today));
});
  </script>

  <div class="footerbar">
    <button id="toTop" class="fab" title="ë§¨ ìœ„ë¡œ">â†‘</button>
  </div>
  <script>
    const toTop=document.getElementById('toTop');
    toTop?.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
    window.addEventListener('scroll', ()=>{
      toTop.style.display = window.scrollY>300 ? 'inline-flex' : 'none';
    }, {passive:true});
	window.addEventListener('load', updateFab);
	
  </script>
</body>
</html>
